name: CI

on: [push, pull_request]

env:
  CACHE_IMAGE: fmrcampos/docker-ci-cache
  GPR_CACHE_IMAGE: docker.pkg.github.com/${{ github.repository }}/docker-ci-cache
  DOCKER_BUILDKIT: 1
  NODE_VERSION: 14.4.0

jobs:
  build:
    name: Docker Hub Cache
    runs-on: ubuntu-latest
    steps:
      - name: Checkout master
        uses: actions/checkout@v1
      - name: Log in to docker hub
        run: echo ${{ secrets.REGISTRY_PASS }} | docker login -u ${{ secrets.REGISTRY_USER }} --password-stdin
      - name: Build static from dockerfile
        run: |
          docker build \
            --target static \
            --cache-from $CACHE_IMAGE:static \
            --tag $CACHE_IMAGE:static \
            --file ./Dockerfile \
            --build-arg BUILDKIT_INLINE_CACHE=1 \
            "."
      - name: Build build from dockerfile
        run: |
          docker build \
            --target build \
            --cache-from $CACHE_IMAGE:static \
            --cache-from $CACHE_IMAGE:build \
            --tag $CACHE_IMAGE:build \
            --file ./Dockerfile \
            --build-arg BUILDKIT_INLINE_CACHE=1 \
            "."
      - name: Build stage from dockerfile
        run: |
          docker build \
            --cache-from $CACHE_IMAGE:build \
            --cache-from $CACHE_IMAGE:stage \
            --tag $CACHE_IMAGE:stage \
            --file ./Dockerfile \
            --build-arg BUILDKIT_INLINE_CACHE=1 \
            "."
      - name: Push static image to Docker Hub
        run: docker push $CACHE_IMAGE:static
      - name: Push build image to Docker Hub
        run: docker push $CACHE_IMAGE:build
      - name: Push stage image to Docker Hub
        run: docker push $CACHE_IMAGE:stage

  build-gpr:
    if: false # https://github.community/t/docker-pull-from-public-github-package-registry-fail-with-no-basic-auth-credentials-error/16358
    name: GitHub Package Registry Cache
    runs-on: ubuntu-latest
    steps:
      - name: Checkout master
        uses: actions/checkout@v1
      - name: Log in to GitHub Package Registry
        run: echo ${{ secrets.GITHUB_TOKEN }} | docker login docker.pkg.github.com -u $GITHUB_ACTOR --password-stdin
      - name: Build static image from Dockerfile
        run: |
          docker pull $GPR_CACHE_IMAGE:static || true
          docker build \
            --target static \
            --cache-from $GPR_CACHE_IMAGE:static \
            --tag $GPR_CACHE_IMAGE:static \
            --file ./Dockerfile \
            # can't use BuildKit for GPR
            "."
      - name: Build build image from Dockerfile
        run: |
          docker pull $GPR_CACHE_IMAGE:build || true
          docker build \
            --target build \
            --cache-from $GPR_CACHE_IMAGE:static \
            --cache-from $GPR_CACHE_IMAGE:build \
            --tag $GPR_CACHE_IMAGE:build \
            --file ./Dockerfile \
            # can't use BuildKit for GPR
            "."
      - name: Build stage image from Dockerfile
        run: |
          docker pull $GPR_CACHE_IMAGE:stage || true
          docker build \
            --cache-from $GPR_CACHE_IMAGE:build \
            --cache-from $GPR_CACHE_IMAGE:stage \
            --tag $GPR_CACHE_IMAGE:stage \
            --file ./Dockerfile \
            --build-arg BUILDKIT_INLINE_CACHE=1 \
            # can't use BuildKit for GPR
            "."
      - name: Push static image to package registry
        run: docker push $GPR_CACHE_IMAGE:static
      - name: Push build image to package registry
        run: docker push $GPR_CACHE_IMAGE:build
      - name: Push stage image to package registry
        run: docker push $GPR_CACHE_IMAGE:stage
  
  test:
    needs: build
    runs-on: ubuntu-latest
    container: fmrcampos/docker-ci-cache:stage
    services:
      postgres:
        image: postgres:10.1
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - name: Check out repository
        uses: actions/checkout@v2

      - name: Install dependencies
        run: |
          apt-get update && apt-get -y install make locales build-essential curl libpq-dev autoconf
          apt -y install libcurl4-openssl-dev libssl-dev pkg-config

      - name: Set locale
        run: |
          echo "LC_ALL=en_US.UTF-8" >> /etc/environment
          echo "en_US.UTF-8 UTF-8" >> /etc/locale.gen
          echo "LANG=en_US.UTF-8" > /etc/locale.conf
          locale-gen en_US.UTF-8

      - name: Setup tests
        run: |
          curl -o- https://raw.githubusercontent.com/creationix/nvm/v0.33.0/install.sh | bash
          export NVM_DIR="$HOME/.nvm" 
          [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
          [ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"
          nvm install $NODE_VERSION
          pip install -U pip setuptools wheel
          pip install -r requirements.txt
          pip install -r requirements/dev.txt
          npm i -g npm
          npm install -g gulp-cli
          npm ci

      - name: Run tests
        run: |
          python -m coverage run -m pytest --strict --postgresql-host postgres
          python -m coverage html
          python -m coverage report -m --fail-under 100
        env:
          # The hostname used to communicate with the PostgreSQL service container
          POSTGRES_HOST: postgres
          # The default PostgreSQL port
          POSTGRES_PORT: 5432

  lint:
    needs: build
    runs-on: ubuntu-latest
    container: fmrcampos/docker-ci-cache:stage
    steps:
      - name: Check out repository
        uses: actions/checkout@v2

      - uses: actions/setup-python@v2
        with:
          python-version: 3.8

      - name: Lint
        run: |
          apt-get update && apt-get install make
          make lint ACTIONS=true

  docs:
    needs: build
    runs-on: ubuntu-latest
    container: fmrcampos/docker-ci-cache:stage
    steps:
      - name: Check out repository
        uses: actions/checkout@v2

      - name: Documentation
        run: |
          apt-get update && apt-get install make
          make docs
  
  deps:
    needs: build
    runs-on: ubuntu-latest
    container: fmrcampos/docker-ci-cache:stage
    steps:
      - name: Check out repository
        uses: actions/checkout@v2

      - name: Dependencies
        run: |
          apt-get update && apt-get -y install build-essential make libpq-dev
          apt -y install libcurl4-openssl-dev libssl-dev pkg-config
          pip install -U pip setuptools wheel
          pip install -r requirements.txt
          pip install -r requirements/dev.txt # this is probably happening twice
          make deps

  licenses:
    needs: build
    runs-on: ubuntu-latest
    container: fmrcampos/docker-ci-cache:stage
    steps:
      - name: Check out repository
        uses: actions/checkout@v2

      - name: Licenses
        run: bin/licenses
  
  translations:
    needs: build
    runs-on: ubuntu-latest
    container: fmrcampos/docker-ci-cache:stage
    steps:
      - name: Check out repository
        uses: actions/checkout@v2

      - name: Translations
        run: |
          apt-get update && apt-get -y install make
          make translations

  static-lint:
    needs: build
    runs-on: ubuntu-latest
    container: fmrcampos/docker-ci-cache:static
    steps:
      - name: Check out repository
        uses: actions/checkout@v2

      - name: Lint
        run: |
          npm install eslint --save-dev
          ./node_modules/.bin/eslint 'warehouse/static/js/**' '**.js' 'tests/frontend/**' --ignore-pattern 'warehouse/static/js/vendor/**'
          ./node_modules/.bin/sass-lint --verbose

  static-tests:
    needs: build
    runs-on: ubuntu-latest
    container: fmrcampos/docker-ci-cache:static
    steps:
      - name: Check out repository
        uses: actions/checkout@v2

      - name: Static Tests
        run: |
          apt-get update && apt-get -y install locales
          echo "LC_ALL=en_US.UTF-8" >> /etc/environment
          echo "en_US.UTF-8 UTF-8" >> /etc/locale.gen
          echo "LANG=en_US.UTF-8" > /etc/locale.conf
          locale-gen en_US.UTF-8
          npm install -D babel
          bin/static_tests

  static-pipeline:
    needs: build
    runs-on: ubuntu-latest
    container: fmrcampos/docker-ci-cache:static
    steps:
      - name: Check out repository
        uses: actions/checkout@v2

      - name: Locale & Dependency Setup
        run: |
          apt-get update && apt-get -y install locales
          echo "LC_ALL=en_US.UTF-8" >> /etc/environment
          echo "en_US.UTF-8 UTF-8" >> /etc/locale.gen
          echo "LANG=en_US.UTF-8" > /etc/locale.conf
          locale-gen en_US.UTF-8
          npm install -D babel

      - name: Static Pipeline
        run: bin/static_pipeline